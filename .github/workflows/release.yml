name: Release

on:
  push:
    tags: ['v*.*.*']

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGES.md

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## PlexMCP ${{ steps.version.outputs.version }}

            ### Docker Images

            Pull the pre-built images:

            ```bash
            # API Server
            docker pull ghcr.io/${{ github.repository_owner }}/plexmcp-api:${{ steps.version.outputs.version }}

            # Web Dashboard
            docker pull ghcr.io/${{ github.repository_owner }}/plexmcp-web:${{ steps.version.outputs.version }}
            ```

            ### Quick Start (Self-Hosting)

            ```bash
            # Clone the repository
            git clone https://github.com/${{ github.repository }}.git
            cd plexmcp

            # Set up environment
            cp .env.example .env
            ./scripts/setup.sh

            # Start with pre-built images
            docker compose --profile prebuilt up -d

            # Open http://localhost:3000
            ```

            ### Changes

            ${{ steps.changelog.outputs.content }}

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.version }}...HEAD

            **Documentation**: https://oss.plexmcp.com
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-changelog:
    name: Update CHANGELOG.md
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: Generate full changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --verbose
        env:
          OUTPUT: CHANGELOG.md

      - name: Commit changelog
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update CHANGELOG.md for ${{ github.ref_name }}"
          file_pattern: CHANGELOG.md
          branch: main
