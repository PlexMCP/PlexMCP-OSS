name: Daily Code Quality Scan

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:  # Allow manual triggers

jobs:
  full-codebase-scan:
    name: Full CodeRabbit Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for comprehensive analysis

      # CodeRabbit CLI Security:
      # - Version pinned via CODERABBIT_VERSION (prevents surprise updates)
      # - Install script verified via SHA256 checksum (detects tampering)
      # - Downloaded to file (not piped directly to sh)
      #
      # To update:
      #   1. Test new version locally: CODERABBIT_VERSION=vX.Y.Z curl -fsSL https://cli.coderabbit.ai/install.sh | sh
      #   2. Download new install.sh: curl -fsSL https://cli.coderabbit.ai/install.sh > install.sh
      #   3. Compute new hash: sha256sum install.sh
      #   4. Update CODERABBIT_VERSION and EXPECTED_INSTALL_SCRIPT_HASH below
      - name: Install CodeRabbit CLI (version pinned + verified)
        env:
          # Pin to specific CLI version (prevents surprise updates)
          CODERABBIT_VERSION: "0.3.5"
          # Expected hash of install.sh (detects script tampering)
          EXPECTED_INSTALL_SCRIPT_HASH: "e41b25da22e00e42134b7164ddd7b07b61a539ec30e6835de290b2034eab07b8"
        run: |
          # Download install script to temp file (not piped to sh)
          TEMP_INSTALLER=$(mktemp)
          echo "ðŸ“¥ Downloading CodeRabbit install script..."
          curl -fsSL https://cli.coderabbit.ai/install.sh -o "$TEMP_INSTALLER"

          # Verify install script hasn't been modified unexpectedly
          ACTUAL_HASH=$(sha256sum "$TEMP_INSTALLER" | cut -d' ' -f1)

          if [ "$ACTUAL_HASH" != "$EXPECTED_INSTALL_SCRIPT_HASH" ]; then
            echo "âŒ SECURITY WARNING: Install script checksum mismatch!"
            echo "   Expected: $EXPECTED_INSTALL_SCRIPT_HASH"
            echo "   Got:      $ACTUAL_HASH"
            echo ""
            echo "This may indicate:"
            echo "  - CodeRabbit updated their install script (normal)"
            echo "  - Potential tampering (investigate)"
            echo ""
            echo "Action required:"
            echo "  1. Review install script changes"
            echo "  2. Update EXPECTED_INSTALL_SCRIPT_HASH if changes are legitimate"
            rm -f "$TEMP_INSTALLER"
            exit 1
          fi

          echo "âœ… Install script verified (SHA256 match)"
          echo "ðŸ“¦ Installing CodeRabbit CLI ${CODERABBIT_VERSION}..."

          # Run installer with version pinning
          CODERABBIT_VERSION="${CODERABBIT_VERSION}" sh "$TEMP_INSTALLER"
          rm -f "$TEMP_INSTALLER"

          # Verify installation
          echo "âœ… Installed version:"
          coderabbit --version

      - name: Authenticate CodeRabbit
        env:
          CODERABBIT_API_KEY: ${{ secrets.CODERABBIT_API_KEY }}
        run: |
          if [ -z "$CODERABBIT_API_KEY" ]; then
            echo "âš ï¸  CODERABBIT_API_KEY not set. Skipping scan."
            exit 0
          fi
          echo "$CODERABBIT_API_KEY" | coderabbit auth login --token-stdin

      - name: Run full codebase review
        continue-on-error: true
        env:
          CODERABBIT_API_KEY: ${{ secrets.CODERABBIT_API_KEY }}
        run: |
          if [ -z "$CODERABBIT_API_KEY" ]; then
            echo "Skipping scan - no API key configured"
            exit 0
          fi

          echo "ðŸ” Starting full codebase review..."

          # Run CodeRabbit review (default output format)
          coderabbit --prompt-only --base main > daily-review.md 2> daily-review.err || {
            echo "CodeRabbit review failed"
            echo "# Daily Review Failed" > daily-review.md
            echo "Review could not complete. Check error log for details." >> daily-review.md
            if [ -f daily-review.err ]; then
              echo "" >> daily-review.md
              echo "## Error Output" >> daily-review.md
              echo '```' >> daily-review.md
              cat daily-review.err >> daily-review.md
              echo '```' >> daily-review.md
            fi
          }

      - name: Generate summary
        if: always()
        run: |
          echo "# Daily Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f daily-review.md ]; then
            cat daily-review.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Review file not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload review artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-review-${{ github.run_number }}
          path: |
            daily-review.md
          retention-days: 30

      - name: Check for critical issues
        id: check_issues
        if: always()
        run: |
          if [ -f daily-review.md ]; then
            # Count critical issues
            CRITICAL_COUNT=$(grep -ci "critical" daily-review.md || echo "0")
            HIGH_COUNT=$(grep -ci "high severity\|severity: high" daily-review.md || echo "0")

            echo "Critical issues: $CRITICAL_COUNT"
            echo "High severity issues: $HIGH_COUNT"

            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 5 ]; then
              echo "quality_issues=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create issue for critical findings
        if: steps.check_issues.outputs.quality_issues == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reviewContent = 'No review data available';

            if (fs.existsSync('daily-review.md')) {
              reviewContent = fs.readFileSync('daily-review.md', 'utf8');
              // Truncate if too long for GitHub issue
              if (reviewContent.length > 60000) {
                reviewContent = reviewContent.substring(0, 60000) + '\n\n... (truncated)';
              }
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Critical Code Quality Issues Found - ${new Date().toISOString().split('T')[0]}`,
              body: `## Daily Code Quality Scan Results

            The automated daily scan has detected critical or high-severity code quality issues.

            **Scan Details:**
            - Run Number: #${{ github.run_number }}
            - Date: ${new Date().toISOString()}
            - [View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ## Review Summary

            ${reviewContent}

            ## Action Required

            Please review the findings and address critical issues before next release.

            **Download Full Report:**
            - [JSON Report (Artifacts)](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `,
              labels: ['code-quality', 'automated', 'needs-review']
            });

            console.log(`Created issue #${issue.data.number}`);

  dependency-audit:
    name: Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Rust security audit
        run: |
          cargo install cargo-audit || true
          cargo audit || echo "::warning::Rust security vulnerabilities found"

      - name: npm security audit
        working-directory: ./web
        run: |
          npm audit --audit-level=moderate || echo "::warning::npm security vulnerabilities found"

      - name: Generate audit summary
        run: |
          echo "# Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security audit completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check job logs for detailed findings." >> $GITHUB_STEP_SUMMARY
